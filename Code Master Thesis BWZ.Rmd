---
title: "Airbnb analyses NY"
output: html_notebook
---

#Load libraries
```{r}

library("tidyverse")
library("broom")
library("caret")
library("knitr")
library("car")
library("kableExtra")
library("tidyr")
library("psych")
library("dplyr")
library("utf8")
library("sentimentr")
library("ggpubr")
library("corrplot")
library("data.table")
library("tidycensus")
library("faraway")
library("ISLR")
library("Metrics")
library("e1071")
library("PerformanceAnalytics")
library("xgboost")
library("devtools")

options(digits=4)
options(scipen=999)

#!diagnostics off
```

#cardinality
```{r message = FALSE, echo = FALSE}
#Set functions
cardinality <- function(x) {
  length(unique(x))
}

first_mode <- function(f) {
  freqs <- table(f)
  first_mode <- names(sort(freqs, decreasing = TRUE))[1]
  first_mode
} 
second_mode <- function(f) {
  freqs <- table(f)
  second_mode <-  names(sort(freqs, decreasing = TRUE))[2]
  second_mode
}

```



#Load dataset
```{r echo = T, results = 'hide'}
#load dataset
airbnb_dataset <- read_csv("airbnb dataset new york.csv")

#create seperate dataset for cleaning and analyses
airbnb_df <- airbnb_dataset

```

#Combine mean monthly listing price with scraped listing price.
```{r}

as.data.frame(table(airbnb_df$price))
as.data.frame(table(airbnb_df$mean_price))

#price has the $ sign before the price. We'll parse the price to only get the integers
airbnb_df$price <- parse_number(airbnb_df$price)

#add mean price to listing price & remove static price
airbnb_df$mean_price[is.na(airbnb_df$mean_price)] <- airbnb_df$price[is.na(airbnb_df$mean_price)]

summary(airbnb_df$price)
summary(airbnb_df$mean_price)

airbnb_df <- select(airbnb_df,
                          -price)

```



#Data composition
```{r}
#database structure
str(airbnb_df)

#file composition, three listings, all variables
kable(airbnb_df[1:5,1:97]) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, font_size = 9) %>%
  scroll_box(width = "910px", height = "400px")

table(airbnb_dataset$last_scraped)
```


#Data cleaning
##Remove irrelevant columns
```{r}
#Remove irrelevant columns
airbnb_df <- select(airbnb_df,
                    -X1,
                    -id,
                    -host_id,
                    -listing_url,
                    -scrape_id,
                    -picture_url,
                    -thumbnail_url,
                    -medium_url,
                    -xl_picture_url,
                    -host_url,
                    -host_name,
                    -host_thumbnail_url,
                    -host_picture_url,
                    -is_business_travel_ready)

#experiences_offered, all values show none
table(airbnb_df$experiences_offered)
airbnb_df <- select(airbnb_df,
                    -experiences_offered)
#host acceptance rate seems to only value "N/A", thus will be omitted from dataset
table(airbnb_df$host_acceptance_rate)
airbnb_df <- select(airbnb_df,
                    -host_acceptance_rate)

#has_availability only has all variables are true this column is irrelevant
table(airbnb_df$has_availability)
airbnb_df <- select(airbnb_df,
                    -has_availability)

table(airbnb_dataset$is_business_travel_ready)

```

##check for duplicate information and remove
```{r}

#Check for location and country
as.data.frame(table(airbnb_df$market))
as.data.frame(table(airbnb_df$street))
as.data.frame(table(airbnb_df$city))
as.data.frame(table(airbnb_df$country))
as.data.frame(table(airbnb_df$state))

#clean location and country
airbnb_df <- airbnb_df %>%
  filter(str_detect(market, 'New York'))

airbnb_df <- airbnb_df %>%
  filter(str_detect(country, 'United States'))

airbnb_df <- airbnb_df %>%
  filter(str_detect(state, 'NY|ny|Ny'))

airbnb_df$state[grepl("ny|Ny", airbnb_df$state)] <- "NY"


#remove columns with double information
airbnb_df <- select(airbnb_df,
                    -street,
                    -is_location_exact,
                    -jurisdiction_names,
                    -host_verifications,
                    -neighbourhood,
                    -country_code,
                    -country,
                    -city,
                    -state,
                    -smart_location,
                    -neighbourhood_cleansed,
                    -requires_license,
                    -host_neighbourhood,
                    -market)

#check for duplicates in summary, space and description
sum_vs_descrip <- airbnb_df$summary == airbnb_df$description
table(sum_vs_descrip)

space_descrip <- airbnb_df$space == airbnb_df$description
table(space_descrip)

space_summary <- airbnb_df$space == airbnb_df$summary
table(space_summary)

airbnb_df <- select(airbnb_df,
                    -summary)

#check whether host listing count is identical across all variables
identical(airbnb_df[['host_listings_count']],airbnb_df[['host_total_listings_count']],airbnb_df[['calculated_host_listings_count']] )

airbnb_df <- select(airbnb_df,
                    -host_total_listings_count,
                    -calculated_host_listings_count)

#check whether last_scraped is the same as calendar_last_scraped
identical(airbnb_df[['last_scraped']],airbnb_df[['calendar_last_scraped']] )
airbnb_df <- select(airbnb_df,
                    -calendar_last_scraped)

```


#check for NA's
```{r}
#No NA's per column
na_per_column <- sort(colSums(sapply(airbnb_df,is.na)), decreasing = TRUE)

#Percentage NA's per column
na_per_columnpercentage <- sort(colSums(sapply(airbnb_df,is.na)/47358*100), decreasing = TRUE)

#Number and percentage of NA's per column
na_table <- as.data.frame(cbind(na_per_column, na_per_columnpercentage))
na_table


#clean dataset, remove columns with too many na's (99%-100%)
airbnb_df <- select(airbnb_df,
                    -license,
                    -square_feet,
                    -weekly_price,
                    -monthly_price)

```

##Check for NA's in relevant columns.
```{r}
#No NA's per column
na_per_column2 <- sort(colSums(sapply(airbnb_df,is.na)), decreasing = TRUE)

#Percentage NA's per column
na_per_columnpercentage2 <- sort(colSums(sapply(airbnb_df,is.na)/47358*100), decreasing = TRUE)

#Number and percentage of NA's per column
na_table2 <- as.data.frame(cbind(na_per_column2, na_per_columnpercentage2))
na_table2

#clean dataset, remove listings containing NA's for host information
airbnb_df<- airbnb_df[complete.cases(airbnb_df$name), ]

airbnb_df <- airbnb_df[complete.cases(airbnb_df$host_since), ]

airbnb_df <- airbnb_df[complete.cases(airbnb_df$host_location), ]

#clean dataset, remove listings containing NA's for accomodation description
airbnb_df <- airbnb_df[complete.cases(airbnb_df$description), ]

#clean dataset, remove listings containing NA's for accomodation content

airbnb_df <- airbnb_df[complete.cases(airbnb_df$beds), ]

airbnb_df <- airbnb_df[complete.cases(airbnb_df$bathrooms), ]

airbnb_df <- airbnb_df[complete.cases(airbnb_df$bedrooms), ]

#clean dataset, remove listings containing NA's for location information
airbnb_df <- airbnb_df[complete.cases(airbnb_df$zipcode), ]

#No NA's per column
na_per_column3 <- sort(colSums(sapply(airbnb_df,is.na)), decreasing = TRUE)

#Percentage NA's per column
na_per_columnpercentage3 <- sort(colSums(sapply(airbnb_df,is.na)/46230*100), decreasing = TRUE)

#Number and percentage of NA's per column
na_table3 <- as.data.frame(cbind(na_per_column3, na_per_columnpercentage3))
na_table3
```


##Overview, current file composition with initial cleaning. 
```{r}
#file composition, three listings, all variables (CLEANED) 
kable(airbnb_df[1:5,1:58]) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, font_size = 9) %>% scroll_box(width = "910px", height = "400px")

#No NA's per column
na_per_column4 <- sort(colSums(sapply(airbnb_df,is.na)), decreasing = TRUE)

#Percentage NA's per column
na_per_columnpercentage4<- sort(colSums(sapply(airbnb_df,is.na)/46230*100), decreasing = TRUE)

#Number and percentage of NA's per column
na_table4 <- as.data.frame(cbind(na_per_column4, na_per_columnpercentage4))
na_table4
```


#convert into new df
```{r}
#Clean dataset
airbnb_cl <- airbnb_df

#check structure
str(airbnb_cl)

```

#check variables individually, clean and recode if necessary

##last_scraped
```{r}
#last_scraped, same month albeit difference of few days in the beginning between the cities.
table(airbnb_cl$last_scraped)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = last_scraped))

as.data.frame(table(airbnb_cl$last_scraped))

```

##name
```{r}
#name will be used for sentiment analyses, clean special characters.

airbnb_cl$name  <- gsub("[^[:alnum:][:space:]\\.\\,\\ ]"," " , airbnb_cl$name)

#remove values with zero
airbnb_cl$name[airbnb_cl$name==""]  <- NA  


```


##space
```{r}
#303702 NA's
#change space to 1 (if containing text) or 0 (if containing NA)
airbnb_cl$space <- as.numeric(!is.na(airbnb_cl$space))
table(airbnb_cl$space)

```

##description
```{r}
#airbnb_cl[grep('^[<]', airbnb_cl$description),]
#airbnb_cl <- airbnb_cl[-grep('^[<]', airbnb_cl$description),]

airbnb_cl$description  <- gsub("[^[:alnum:][:space:]\\.\\,\\ ]"," " , airbnb_cl$description)

airbnb_cl$description[airbnb_cl$description==""]  <- NA  


```

##neighbourhood overview
```{r}
#398111 NA's
#change space to 1 (if containing text) or 0 (if containing NA)
airbnb_cl$neighborhood_overview <- as.numeric(!is.na(airbnb_cl$neighborhood_overview))
table(airbnb_cl$neighborhood_overview)
```

##notes
```{r}
#585324 NA's
#change space to 1 (if containing text) or 0 (if containing NA)
airbnb_cl$notes <- as.numeric(!is.na(airbnb_cl$notes))
table(airbnb_cl$notes)
```

##transit
```{r}
#399335 NA's
#change space to 1 (if containing text) or 0 (if containing NA)
airbnb_cl$transit <- as.numeric(!is.na(airbnb_cl$transit))
table(airbnb_cl$transit)
```

##access
```{r}
#411320 NA's
#change space to 1 (if containing text) or 0 (if containing NA)
airbnb_cl$access <- as.numeric(!is.na(airbnb_cl$access))
table(airbnb_cl$access)
```

##interaction
```{r}
#431191 NA's
#change space to 1 (if containing text) or 0 (if containing NA)
airbnb_cl$interaction <- as.numeric(!is.na(airbnb_cl$interaction))
table(airbnb_cl$interaction)
```

##house rules
```{r}
#376505 NA's
#change space to 1 (if containing text) or 0 (if containing NA)
airbnb_cl$house_rules <- as.numeric(!is.na(airbnb_cl$house_rules))
table(airbnb_cl$house_rules)
```

##host since
```{r}
ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = host_since))

str(airbnb_cl$host_since)

#variable will be used in feature engineering

```

##host location
```{r}

as.data.frame(table(airbnb_cl$host_location))
#clean

airbnb_cl[grep('^[<]', airbnb_cl$host_location),]

airbnb_cl <- airbnb_cl[-grep('^[<]', airbnb_cl$host_location),]

as.data.frame(table(airbnb_cl$host_location))

#variable will be used in feature engineering

```

##host about
```{r}
#388008 NA's
#transform host about to 0 (no discription) and 1 (description)
airbnb_cl$host_about <- as.numeric(!is.na(airbnb_cl$host_about))
table(airbnb_cl$host_about)
```

##host response time
```{r}
#change host response time and order based on response time
table(airbnb_cl$host_response_time)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = host_response_time))

airbnb_cl$host_response_time <- factor(airbnb_cl$host_response_time, ordered = FALSE, levels = c("within an hour", "within a few hours", "within a day", "a few days or more", "N/A"))

table(airbnb_cl$host_response_time)

```

##host reponse rate
```{r}
test <- airbnb_cl
airbnb_cl <- test

as.data.frame(table(airbnb_cl$host_response_rate))
str(airbnb_cl$host_response_rate)

#set NA to 0 and parse % to only get the integer

airbnb_cl$host_response_rate <- parse_number(airbnb_cl$host_response_rate)

airbnb_cl$host_response_rate[is.na(airbnb_cl$host_response_rate)] <- 0

airbnb_cl$host_response_rate <- as.numeric(airbnb_cl$host_response_rate)


ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(host_response_rate))

as.data.frame(table(airbnb_cl$host_response_rate))

```

##host is superhost
```{r}
#host superhost will be converted to true/false values
table(airbnb_cl$host_is_superhost)

airbnb_cl$host_is_superhost <- as.numeric(ifelse(airbnb_cl$host_is_superhost == 'TRUE', 1, 0))

table(airbnb_cl$host_is_superhost)
```


#host listings count
```{r}

as.data.frame(table(airbnb_cl$host_listings_count))

#remove host with zero listings
airbnb_cl <- subset(airbnb_cl, host_listings_count > 0)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = host_listings_count))

summary(airbnb_cl$host_listings_count)
summary(scale(airbnb_cl$host_listings_count + 1))

as.data.frame(table(airbnb_cl$host_listings_count))

```


#host has profile pic
```{r}
table(airbnb_cl$host_has_profile_pic)
airbnb_cl$host_has_profile_pic <- as.numeric(ifelse(airbnb_cl$host_has_profile_pic == 'TRUE', 1, 0))
table(airbnb_cl$host_has_profile_pic)
```

#host has identity verified
```{r}
table(airbnb_cl$host_identity_verified)
airbnb_cl$host_identity_verified <- as.numeric(ifelse(airbnb_cl$host_identity_verified == 'TRUE', 1, 0))
table(airbnb_cl$host_identity_verified)
```
#neighbourhood_group_cleansed
```{r}
table(airbnb_cl$neighbourhood_group_cleansed)

airbnb_cl$neighbourhood_group_cleansed <- as.factor(airbnb_cl$neighbourhood_group_cleansed)

```


#zipcode
```{r}

as.data.frame(table(airbnb_cl$zipcode))


airbnb_cl$zipcode[airbnb_cl$zipcode==""]  <- NA  

table(airbnb_cl$zipcode)

#Convert zipcode data to neighbourhood regions
#Remove spaces
airbnb_cl$zipcode <- gsub(" ","", airbnb_cl$zipcode)

airbnb_cl$zipcode <- as.character(airbnb_cl$zipcode)

#convert NY zipcodes to neighbourhood districts

#Central Bronx	10453, 10457, 10460
airbnb_cl$zipcode[grepl("10453|10457|10460", airbnb_cl$zipcode)] <- "Central Bronx"

#Bronx Park and Fordham	10458, 10467, 10468
airbnb_cl$zipcode[grepl("10458|10467|10468", airbnb_cl$zipcode)] <- "Bronx Park and Fordham"

#High Bridge and Morrisania	10451, 10452, 10456
airbnb_cl$zipcode[grepl("10451|10452|10456", airbnb_cl$zipcode)] <- "High Bridge and Morrisania"

#Hunts Point and Mott Haven	10454, 10455, 10459, 10474
airbnb_cl$zipcode[grepl("10454|10455|10459|10474", airbnb_cl$zipcode)] <- "Hunts Point and Mott Haven"

#Kingsbridge and Riverdale	10463, 10471
airbnb_cl$zipcode[grepl("10463|10471", airbnb_cl$zipcode)] <- "Kingsbridge and Riverdale"

#Northeast Bronx	10466, 10469, 10470, 10475
airbnb_cl$zipcode[grepl("10466|10469|10470|10475", airbnb_cl$zipcode)] <- "Northeast Bronx"

#Southeast Bronx	10461, 10462,10464, 10465, 10472, 10473
airbnb_cl$zipcode[grepl("10461|10462|10464|10465|10472|10473", airbnb_cl$zipcode)] <- "Southeast Bronx"

#Central Brooklyn	11212, 11213, 11216, 11233, 11238
airbnb_cl$zipcode[grepl("11212|11213|11216|11233|11238", airbnb_cl$zipcode)] <- "Central Brooklyn"

#Southwest Brooklyn	11209, 11214, 11228
airbnb_cl$zipcode[grepl("11209|11214|11228", airbnb_cl$zipcode)] <- "Southwest Brooklyn"

#Borough Park	11204, 11218, 11219, 11230
airbnb_cl$zipcode[grepl("11204|11218|11219|11230", airbnb_cl$zipcode)] <- "Borough Park"

#Canarsie and Flatlands	11234, 11236, 11239
airbnb_cl$zipcode[grepl("11234|11236|11239", airbnb_cl$zipcode)] <- "Canarsie and Flatlands"

#Southern Brooklyn	11223, 11224, 11229, 11235
airbnb_cl$zipcode[grepl("11223|11224|11229|11235", airbnb_cl$zipcode)] <- "Southern Brooklyn"

#Northwest Brooklyn	11201, 11205, 11215, 11217, 11231
airbnb_cl$zipcode[grepl("11201|11205|11215|11217|11231", airbnb_cl$zipcode)] <- "Northwest Brooklyn"

#Flatbush	11203, 11210, 11225, 11226
airbnb_cl$zipcode[grepl("11203|11210|11225|11226", airbnb_cl$zipcode)] <- "Flatbush"

#East New York and New Lots	11207, 11208
airbnb_cl$zipcode[grepl("11207|11208", airbnb_cl$zipcode)] <- "East New York and New Lots"

#Greenpoint	11211, 11222
airbnb_cl$zipcode[grepl("11211|11222", airbnb_cl$zipcode)] <- "Greenpoint"

#Sunset Park	11220, 11232
airbnb_cl$zipcode[grepl("11220|11232", airbnb_cl$zipcode)] <- "Sunset Park"

#Bushwick and Williamsburg	11206, 11221, 11237
airbnb_cl$zipcode[grepl("11206|11221|11237|11249", airbnb_cl$zipcode)] <- "Bushwick and Williamsburg"

#Manhattan	Central Harlem	10026, 10027, 10030, 10037, 10039
airbnb_cl$zipcode[grepl("10026|10027|10030|10037|10039", airbnb_cl$zipcode)] <- "Central Harlem"

#Chelsea and Clinton	10001, 10011, 10018, 10019, 10020, 10036
airbnb_cl$zipcode[grepl("10001|10011|10018|10019|10020|10036", airbnb_cl$zipcode)] <- "Chelsea and Clinton"

#East Harlem	10029, 10035
airbnb_cl$zipcode[grepl("10029|10035", airbnb_cl$zipcode)] <- "East Harlem"

#Gramercy Park and Murray Hill	10010, 10016, 10017, 10022
airbnb_cl$zipcode[grepl("10010|10016|10017|10022", airbnb_cl$zipcode)] <- "Gramercy Park and Murray Hill"

#Greenwich Village and Soho	10012, 10013, 10014
airbnb_cl$zipcode[grepl("10012|10013|10014", airbnb_cl$zipcode)] <- "Greenwich Village and Soho"

#Lower Manhattan	10004, 10005, 10006, 10007, 10038, 10280
airbnb_cl$zipcode[grepl("10004|10005|10006|10007|10038|10280", airbnb_cl$zipcode)] <- "Lower Manhattan"

#Lower East Side	10002, 10003, 10009
airbnb_cl$zipcode[grepl("10002|10003|10009", airbnb_cl$zipcode)] <- "Lower East Side"

#Upper East Side	10021, 10028, 10044, 10065, 10075, 10128
airbnb_cl$zipcode[grepl("10021|10028|10044|10065|10075|10128", airbnb_cl$zipcode)] <- "Upper East Side"

#Upper West Side	10023, 10024, 10025
airbnb_cl$zipcode[grepl("10023|10024|10025", airbnb_cl$zipcode)] <- "Upper West Side"

#Inwood and Washington Heights	10031, 10032, 10033, 10034, 10040
airbnb_cl$zipcode[grepl("10031|10032|10033|10034|10040", airbnb_cl$zipcode)] <- "Inwood and Washington Heights"

#Queens	Northeast Queens	11361, 11362, 11363, 11364
airbnb_cl$zipcode[grepl("11361|11362|11363|11364", airbnb_cl$zipcode)] <- "Northeast Queens"

#North Queens	11354, 11355, 11356, 11357, 11358, 11359, 11360
airbnb_cl$zipcode[grepl("11354|11355|11356|11357|11358|11359|11360", airbnb_cl$zipcode)] <- "North Queens"

#Central Queens	11365, 11366, 11367
airbnb_cl$zipcode[grepl("11365|11366|11367", airbnb_cl$zipcode)] <- "Central Queens"

#Jamaica	11412, 11423, 11432, 11433, 11434, 11435, 11436
airbnb_cl$zipcode[grepl("11412|11423|11432|11433|11434|11435|11436", airbnb_cl$zipcode)] <- "Jamaica"

#Northwest Queens	11101, 11102, 11103, 11104, 11105, 11106
airbnb_cl$zipcode[grepl("11101|11102|11103|11104|11105|11106", airbnb_cl$zipcode)] <- "Northwest Queens"

#West Central Queens	11374, 11375, 11379, 11385
airbnb_cl$zipcode[grepl("11374|11375|11379|11385", airbnb_cl$zipcode)] <- "West Central Queens"

#Rockaways	11691, 11692, 11693, 11694, 11695, 11697
airbnb_cl$zipcode[grepl("11691|11692|11693|11694|11695|11697", airbnb_cl$zipcode)] <- "Rockaways"

#Southeast Queens	11004, 11005, 11411, 11413, 11422, 11426, 11427, 11428, 11429
airbnb_cl$zipcode[grepl("11004|11005|11411|11413|11422|11426|11427|11428|11429", airbnb_cl$zipcode)] <- "Southeast Queens"

#Southwest Queens	11414, 11415, 11416, 11417, 11418, 11419, 11420, 11421
airbnb_cl$zipcode[grepl("11414|11415|11416|11417|11418|11419|11420|11421", airbnb_cl$zipcode)] <- "Southwest Queens"

#West Queens	11368, 11369, 11370, 11372, 11373, 11377, 11378
airbnb_cl$zipcode[grepl("11368|11369|11370|11372|11373|11377|11378", airbnb_cl$zipcode)] <- "West Queens"

#Staten Island	Port Richmond	10302, 10303, 10310
airbnb_cl$zipcode[grepl("10302|10303|10310", airbnb_cl$zipcode)] <- "Port Richmond"

#South Shore	10306, 10307, 10308, 10309, 10312
airbnb_cl$zipcode[grepl("10306|10307|10308|10309|10312", airbnb_cl$zipcode)] <- "South Shore"

#Stapleton and St. George	10301, 10304, 10305
airbnb_cl$zipcode[grepl("10301|10304|10305", airbnb_cl$zipcode)] <- "Stapleton and St. George"


#Mid-Island	10314
airbnb_cl$zipcode[grepl("10314", airbnb_cl$zipcode)] <- "Mid-Island"


as.data.frame(table(airbnb_cl$zipcode))

airbnb_cl <- airbnb_cl %>%
  filter(str_detect(zipcode, 'Central Bronx|Bronx Park and Fordham|High Bridge and Morrisania|Hunts Point and Mott Haven|Kingsbridge and Riverdale|Northeast Bronx|Southeast Bronx|Central Brooklyn|Southwest Brooklyn|Borough Park|Canarsie and Flatlands|Southern Brooklyn|Northwest Brooklyn|Flatbush|East New York and New Lots|Greenpoint|Sunset Park|Bushwick and Williamsburg|Central Harlem|Bushwick and Williamsburg|Central Harlem|Chelsea and Clinton|East Harlem|Gramercy Park and Murray Hill|Greenwich Village and Soho|Lower Manhattan|Lower East Side|Upper East Side|Upper West Side|Inwood and Washington Heights|Northeast Queens|North Queens|Central Queens|Jamaica|Northwest Queens|West Central Queens|Rockaways|Southeast Queens|Southwest Queens|West Queens|Port Richmond|South Shore|Stapleton and St. George'))


#airbnb_cl <- airbnb_cl %>%
 # filter(str_detect(zipcode, 'Bronx|Brooklyn|Manhattan|Queens|Staten Island'))

as.data.frame(table(airbnb_cl$zipcode))

airbnb_cl$zipcode <- as.factor(airbnb_cl$zipcode)

```




#latitude and longtitude will be used for data visualization
```{r}
#take subset for data visualization
location_df <- airbnb_cl %>% select(latitude, longitude)

#explore data
summary(airbnb_cl$latitude)
summary(airbnb_cl$longitude)

plot(airbnb_cl$longitude, airbnb_cl$latitude)


```


#property type
```{r}
as.data.frame(table(airbnb_cl$property_type))

airbnb_cl <- airbnb_cl[!grepl("(Cuba)|(Taiwan)", airbnb_cl$property_type),]

ggplot(data=airbnb_cl) +
  geom_bar(mapping = aes(x = property_type))

#gather property_types with less than 100 properties into "other" column
#More than a year ago
airbnb_cl$property_type[grepl("Aparthote|Boat|Boutique hotel|Bungalow|Cabin|Camper/RV|Casa particular (Cuba)|Castle|Cave|Cottage|Guesthouse|Hostel|Hotel|Hut|Island|Other|Tent|Tiny house|Train|Villa|Nature lodge", airbnb_cl$property_type)] <- "Other"

as.data.frame(table(airbnb_cl$property_type))


```

#room type
```{r}
as.data.frame(table(airbnb_cl$room_type))

airbnb_cl$room_type <- as.factor(airbnb_cl$room_type)

ggplot(data=airbnb_cl) +
  geom_bar(mapping = aes(x = room_type))

```

#accomodates
```{r}
table(airbnb_cl$accommodates)

ggplot(data=airbnb_cl) +
  geom_bar(mapping = aes(x = accommodates))


```

#bathrooms
```{r}
table(airbnb_cl$bathrooms)
#a full number (e.g. 1,2,3) stands for bathroom with shower & toilet. 0.5 means only toilet and sink.

ggplot(data=airbnb_cl) +
  geom_bar(mapping = aes(x = bathrooms))


```

#bedrooms
```{r}
table(airbnb_cl$bedrooms)

ggplot(data=airbnb_cl) +
  geom_bar(mapping = aes(x = bedrooms))


```

#beds
```{r}
table(airbnb_cl$beds)

ggplot(data=airbnb_cl) +
  geom_bar(mapping = aes(x = beds))



```

#bed type
```{r}
table(airbnb_cl$bed_type)

airbnb_cl$bed_type <- as.factor(airbnb_cl$bed_type)

ggplot(data=airbnb_cl) +
  geom_bar(mapping = aes(x = bed_type))

```

#amenities
```{r}
#will be feature engineered


```


#security deposit
```{r}

#fallback
test <- airbnb_cl
airbnb_cl <- test

as.data.frame(table(airbnb_cl$security_deposit))

#we'll convert values not explicity specified to 0
airbnb_cl$security_deposit[is.na(airbnb_cl$security_deposit)] <- 0

str(airbnb_cl$security_deposit)

#and parse the amount
airbnb_cl$security_deposit <- parse_number(airbnb_cl$security_deposit)

airbnb_cl$security_deposit <- as.numeric(airbnb_cl$security_deposit)

summary(airbnb_cl$security_deposit)

#explore
summary(airbnb_cl$security_deposit)

ggdensity(airbnb_cl$security_deposit, 
          main = "Density plot of security deposit",
          xlab = "Security Deposit")


```

#cleaning fee
```{r}

#fallback
test <- airbnb_cl
airbnb_cl <- test

as.data.frame(table(airbnb_cl$cleaning_fee))

#we'll convert values not explicity specified to 0
airbnb_cl$cleaning_fee[is.na(airbnb_cl$cleaning_fee)] <- 0

#and parse the amount
airbnb_cl$cleaning_fee <- parse_number(airbnb_cl$cleaning_fee)
airbnb_cl$cleaning_fee <- as.numeric(airbnb_cl$cleaning_fee)

#explore
summary(airbnb_cl$cleaning_fee)

ggdensity(airbnb_cl$cleaning_fee, 
          main = "Density plot of cleaning fee",
          xlab = "Cleaning Fee")



```

#guests included
```{r}
table(airbnb_cl$guests_included)

as.data.frame(table(airbnb_cl$guests_included))

#explore
summary(airbnb_cl$guests_included)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = guests_included))

ggdensity(airbnb_cl$guests_included, 
          main = "Density plot of guests included",
          xlab = "Guests Included")

```

#extra people
```{r}

as.data.frame(table(airbnb_cl$extra_people))

#we'll parse the amount
airbnb_cl$extra_people <- parse_number(airbnb_cl$extra_people)
airbnb_cl$extra_people <- as.numeric(airbnb_cl$extra_people)

#explore
summary(airbnb_cl$extra_people)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = extra_people))

ggdensity(airbnb_cl$extra_people, 
          main = "Density plot of extra people",
          xlab = "Extra People")


```


#minimum nights
```{r}

as.data.frame(table(airbnb_cl$minimum_nights))

#explore
summary(airbnb_cl$minimum_nights)

ggdensity(airbnb_cl$minimum_nights, 
          main = "Density plot of minimum nights",
          xlab = "Minimum Nights")

#drop listings where minimum nigths is above 90
airbnb_cl <- subset(airbnb_cl, minimum_nights < 91)


```

#maximum nights
```{r}

#fallback
test <- airbnb_cl
airbnb_cl <- test

as.data.frame(table(airbnb_cl$maximum_nights))

#explore
summary(airbnb_cl$maximum_nights)

ggdensity(airbnb_cl$maximum_nights, 
          main = "Density plot of maximum nights",
          xlab = "Maximum Nights")

#drop listings where minimum nigths is above 1125
airbnb_cl <- subset(airbnb_cl, maximum_nights < 1126)

```

#calendar updated
```{r}

#Calendar updated
as.data.frame(sort(table(airbnb_cl$calendar_updated)))

str(airbnb_cl$calendar_updated)

summary(airbnb_cl$calendar_updated)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = calendar_updated))

#More than a year ago
airbnb_cl$calendar_updated[grepl("83 months ago|82 months ago|81 months ago|80 months ago|79 months ago|78 months ago|77 months ago|76 months ago|75 months ago|74 months ago|73 months ago|72 months ago|71 months ago|70 months ago|69 months ago|68 months ago|67 months ago|66 months ago|65 months ago|64 months ago|63 months ago|62 months ago|61 months ago|60 months ago|59 months ago|58 months ago|57 months ago|56 months ago|55 months ago|54 months ago|53 months ago|52 months ago|51 months ago|50 months ago|49 months ago|48 months ago|47 months ago|46 months ago|45 months ago|44 months ago|43 months ago|42 months ago|41 months ago|40 months ago|39 months ago|38 months ago|37 months ago|36 months ago|35 months ago|34 months ago|33 months ago|32 months ago|31 months ago|30 months ago|29 months ago|28 months ago|27 months ago|26 months ago|25 months ago|24 months ago|23 months ago|22 months ago|21 months ago|20 months ago|19 months ago|18 months ago|17 months ago|16 months ago|15 months ago|14 months ago|13 months ago", airbnb_cl$calendar_updated)] <- "More than a year ago"

#Between six to twelve months ago
airbnb_cl$calendar_updated[grepl("12 months ago|11 months ago|10 months ago|9 months ago|8 months ago|7 months ago|6 months ago", airbnb_cl$calendar_updated)] <- "Six to twelve months ago"

#Between one to six months ago
airbnb_cl$calendar_updated[grepl("5 months ago|4 months ago|3 months ago|2 months ago|7 weeks ago|6 weeks ago|5 weeks ago|4 weeks ago|1 month ago", airbnb_cl$calendar_updated)] <- "One to five months ago"

#Between one to three weeks ago
airbnb_cl$calendar_updated[grepl("3 weeks ago|2 weeks ago|a week ago|1 week ago", airbnb_cl$calendar_updated)] <- "One to three weeks ago"

#Less than a week ago
airbnb_cl$calendar_updated[grepl("6 days ago|5 days ago|4 days ago|3 days ago|2 days ago|yesterday|today", airbnb_cl$calendar_updated)] <- "Less than a week ago"

#Never
airbnb_cl$calendar_updated[grepl("never", airbnb_cl$calendar_updated)] <- "Never"

as.data.frame(sort(table(airbnb_cl$calendar_updated)))

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = calendar_updated))

airbnb_cl$calendar_updated <- as.factor(airbnb_cl$calendar_updated)

```

#availability_30
```{r}

#fallback
test <- airbnb_cl
airbnb_cl <- test

as.data.frame(table(airbnb_cl$availability_30))

#explore
summary(airbnb_cl$availability_30)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = availability_30))

ggdensity(airbnb_cl$availability_30, 
          main = "Density plot of availability 30",
          xlab = "Availability 30")


```

#availability_60
```{r}

#fallback
test <- airbnb_cl
airbnb_cl <- test

as.data.frame(table(airbnb_cl$availability_60))

#explore
summary(airbnb_cl$availability_60)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = availability_60))

ggdensity(airbnb_cl$availability_60, 
          main = "Density plot of availability 60",
          xlab = "Availability 60")


```

#availability_90
```{r}

#fallback
test <- airbnb_cl
airbnb_cl <- test

as.data.frame(table(airbnb_cl$availability_90))

#explore
summary(airbnb_cl$availability_90)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = availability_90))

ggdensity(airbnb_cl$availability_90, 
          main = "Density plot of availability 90",
          xlab = "Availability 90")

```

#availability_365
```{r}

#fallback
test <- airbnb_cl
airbnb_cl <- test

as.data.frame(table(airbnb_cl$availability_365))

#explore
summary(airbnb_cl$availability_365)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = availability_365))

ggdensity(airbnb_cl$availability_365, 
          main = "Density plot of availability 365",
          xlab = "Availability 365")



```

#number of reviews
```{r}

#fallback
test <- airbnb_cl
airbnb_cl <- test

as.data.frame(table(airbnb_cl$number_of_reviews))

#explore
summary(airbnb_cl$number_of_reviews)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = number_of_reviews))

ggdensity(airbnb_cl$number_of_reviews, 
          main = "Density plot of number of reviews",
          xlab = "Number of Reviews")



```

#first_review & last_review
```{r}

#will be used for feature engineering


```

#Check current na's left
```{r}

#No NA's per column
na_per_column5 <- sort(colSums(sapply(airbnb_cl,is.na)), decreasing = TRUE)

#Percentage NA's per column
na_per_columnpercentage5<- sort(colSums(sapply(airbnb_cl,is.na)/45931*100), decreasing = TRUE)

#Number and percentage of NA's per column
na_table5 <- as.data.frame(cbind(na_per_column5, na_per_columnpercentage5))
na_table5
```

#review_scores_rating
```{r}

#fallback
test <- airbnb_cl
airbnb_cl <- test

as.data.frame(table(airbnb_cl$review_scores_rating))

#Parse score rating and review_scores_rating Na to 0 review
airbnb_cl$review_scores_rating[is.na(airbnb_cl$review_scores_rating)] <- 0

as.data.frame(table(airbnb_cl$review_scores_rating))

str(airbnb_cl$review_scores_rating)


#explore

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = review_scores_rating))


```

#review scores (accuracy, cleanliness, checkin, communication, location, value)
```{r}
as.data.frame(table(airbnb_cl$review_scores_accuracy))
as.data.frame(table(airbnb_cl$review_scores_cleanliness))
as.data.frame(table(airbnb_cl$review_scores_checkin))
as.data.frame(table(airbnb_cl$review_scores_communication))
as.data.frame(table(airbnb_cl$review_scores_location))
as.data.frame(table(airbnb_cl$review_scores_value))

#Set Na to 0
airbnb_cl$review_scores_accuracy[is.na(airbnb_cl$review_scores_accuracy)] <- 0
airbnb_cl$review_scores_cleanliness[is.na(airbnb_cl$review_scores_cleanliness)] <- 0
airbnb_cl$review_scores_checkin[is.na(airbnb_cl$review_scores_checkin)] <- 0
airbnb_cl$review_scores_communication[is.na(airbnb_cl$review_scores_communication)] <- 0
airbnb_cl$review_scores_location[is.na(airbnb_cl$review_scores_location)] <- 0
airbnb_cl$review_scores_value[is.na(airbnb_cl$review_scores_value)] <- 0

#explore
summary(airbnb_cl$review_scores_accuracy)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = review_scores_accuracy))

ggdensity(airbnb_cl$review_scores_accuracy, 
          main = "Density plot of review_scores_accuracy",
          xlab = "review_scores_accuracy")

summary(airbnb_cl$review_scores_cleanliness)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = review_scores_cleanliness))

ggdensity(airbnb_cl$review_scores_cleanliness, 
          main = "Density plot of review_scores_cleanliness",
          xlab = "review_scores_cleanliness")

summary(airbnb_cl$review_scores_checkin)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = review_scores_checkin))

ggdensity(airbnb_cl$review_scores_checkin, 
          main = "Density plot of review_scores_checkin",
          xlab = "review_scores_checkin")

summary(airbnb_cl$review_scores_communication)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = review_scores_communication))

ggdensity(airbnb_cl$review_scores_communication, 
          main = "Density plot of review_scores_communication",
          xlab = "review_scores_communication")

summary(airbnb_cl$review_scores_location)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = review_scores_location))

ggdensity(airbnb_cl$review_scores_location, 
          main = "Density plot of review_scores_location",
          xlab = "review_scores_location")

summary(airbnb_cl$review_scores_value)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = review_scores_value))

ggdensity(airbnb_cl$review_scores_value, 
          main = "Density plot of review_scores_value",
          xlab = "review_scores_value")





```


#instant bookable
```{r}
table(airbnb_cl$instant_bookable)
airbnb_cl$instant_bookable <- as.numeric(ifelse(airbnb_cl$instant_bookable == 'TRUE', 1, 0))

```

#cancellation policy
```{r}
as.data.frame(table(airbnb_cl$cancellation_policy))

#explore
ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = cancellation_policy))

#combine values with low observations into other
airbnb_cl$cancellation_policy[grepl("long_term|super_strict_30|super_strict_60|strict", airbnb_cl$cancellation_policy)] <- "Other"

airbnb_cl$cancellation_policy <- as.factor(airbnb_cl$cancellation_policy)

```

#requires guest profile picture
```{r}
table(airbnb_cl$require_guest_profile_picture)
airbnb_cl$require_guest_profile_picture <- as.numeric(ifelse(airbnb_cl$require_guest_profile_picture == 'TRUE', 1, 0))

```

#require guest phone verification
```{r}
table(airbnb_cl$require_guest_phone_verification)
airbnb_cl$require_guest_phone_verification <- as.numeric(ifelse(airbnb_cl$require_guest_phone_verification == 'TRUE', 1, 0))

```

#reviews per month
```{r}
as.data.frame(table(airbnb_cl$reviews_per_month))

airbnb_cl$reviews_per_month[is.na(airbnb_cl$reviews_per_month)] <- 0

summary(airbnb_cl$reviews_per_month)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = reviews_per_month))

ggdensity(airbnb_cl$reviews_per_month, 
          main = "Density plot of reviews_per_month",
          xlab = "reviews_per_month")
```

##Target variable price
#price
```{r}

#drop listings where price is 0
airbnb_cl <- subset(airbnb_cl, mean_price > 0)

#explore
summary(airbnb_cl$mean_price)

ggplot(data = airbnb_cl) +
  geom_bar(mapping = aes(x = mean_price))

ggdensity(airbnb_cl$mean_price, 
          main = "Density plot of price",
          xlab = "Price")

summary(log(airbnb_cl$mean_price))


```

#check all variables

```{r}
#Check NA's
na_per_column6 <- sort(colSums(sapply(airbnb_cl,is.na)), decreasing = TRUE)

#Percentage NA's per column
na_per_columnpercentage6 <- sort(colSums(sapply(airbnb_cl,is.na)/45918*100), decreasing = TRUE)

#Number and percentage of NA's per column
na_table6 <- as.data.frame(cbind(na_per_column6, na_per_columnpercentage6))
na_table6

#Check file composition
kable(airbnb_cl[1:5,1:58]) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, font_size = 9) %>% scroll_box(width = "910px", height = "400px")

#Save cleaned dataset
#write.csv(airbnb_cl, file = "airbnb_cl.csv")



```


```{r}
#Create new dataset for feature engineering
airbnb_nv <- airbnb_cl

```


#Add additional features
- Listing name analyses:
  - Number of characters
  - Sentiment
- Listing description analyses:
  - Number of characters
  - Sentiment  
- Hosting duration
- First booking duration
- Last booking duration
- Host local
- Listing duration
- Amenities per listing
- Amenities type

###Listing name analyses
```{r}
#fallback
test <- airbnb_nv
airbnb_nv <- test

#Add listing name sentiment

name_sentiment <- get_sentences(airbnb_nv$name)
name_sentiment <- sentiment_by(name_sentiment)

airbnb_nv$name_word_count=name_sentiment$word_count
airbnb_nv$ave_name_sentiment=name_sentiment$ave_sentiment

#summary
summary(airbnb_nv$name_word_count)
summary(airbnb_nv$ave_name_sentiment)

#remove listings with zero word count
airbnb_nv$name_word_count[airbnb_nv$name_word_count==0] <- NA
airbnb_nv <- airbnb_nv[complete.cases(airbnb_nv$name_word_count), ]

summary(airbnb_nv$ave_name_sentiment)

```

###Listing description analyses
```{r}

airbnb_nv$description <- iconv(enc2utf8(airbnb_nv$description),sub="byte")

#Add listing description sentiment

##sentiment, get sentences
des1_s <- get_sentences(airbnb_nv$description)

#sentiment, get sentiment
des1_s <- sentiment_by(des1_s)

##combine df's
description_sentiment <- des1_s

#add variables to dataset
airbnb_nv$description_word_count=description_sentiment$word_count
airbnb_nv$ave_description_sentiment=description_sentiment$ave_sentiment

#summary
summary(airbnb_nv$description_word_count)
summary(airbnb_nv$ave_description_sentiment)

#remove listings with zero word count
airbnb_nv$description_word_count[airbnb_nv$description_word_count==0] <- NA
airbnb_nv <- airbnb_nv[complete.cases(airbnb_nv$description_word_count), ]

```


###Host duration
```{r}
#add variable that calculate the number of days that the host is host
airbnb_nv <- airbnb_nv %>% mutate(host_duration = as.numeric(difftime(airbnb_nv$last_scraped, airbnb_nv$host_since, unit = 'days')))

#summary
summary(airbnb_nv$host_duration)

```


###Host local
```{r}
#calculate whether the host is a local (e.g. from the same city or not)

#NY
airbnb_nv <- airbnb_nv %>% mutate(host_local = as.numeric(str_detect(host_location, coll("New York", ignore_case = TRUE))))

table(airbnb_nv$host_local)

#Check distrbution local and not local
as.data.frame(table(airbnb_nv$host_local))



```

###First review duration
```{r}
#fallback
test <- airbnb_nv
airbnb_nv <- test

#calculate listing duration
airbnb_nv <- airbnb_nv %>% 
  mutate(first_review_duration = as.numeric(difftime(airbnb_nv$last_scraped, airbnb_nv$first_review, unit = 'days')))

#summary
summary(airbnb_nv$first_review_duration)

airbnb_nv$first_review_duration[is.na(airbnb_nv$first_review_duration)] <- 685

```

###Last review duration
```{r}
#fallback
test <- airbnb_nv
airbnb_nv <- test

#calculate listing duration
airbnb_nv <- airbnb_nv %>% 
  mutate(last_review_duration = as.numeric(difftime(airbnb_nv$last_scraped, airbnb_nv$last_review, unit = 'days')))

#summary
summary(airbnb_nv$last_review_duration)

airbnb_nv$last_review_duration[is.na(airbnb_nv$last_review_duration)] <- 211


```

###Amenities per listing
```{r}
#count number of amenities per listing and add new variable with total amenities per listing
airbnb_nv$amenities <- iconv(enc2utf8(airbnb_nv$amenities),sub="byte")

airbnb_nv <- airbnb_nv %>% mutate(total_amenities = ifelse(nchar(amenities)>2, str_count(amenities, ',')+1, 0))

#summary
summary(airbnb_nv$total_amenities)

```

###Amenities included
```{r}
test <- airbnb_nv
airbnb_nv <- test

#remove special symbols except for ,
airbnb_nv$amenities  <- gsub("[{}\"\"]"," " , airbnb_nv$amenities ,ignore.case = TRUE)

airbnb_nv$amenities <- gsub(" ","", airbnb_nv$amenities)

#Create dummies for all amenities
split  <- strsplit(airbnb_nv$amenities,",")
splitlevel <- unique(unlist(split))

airbnb_nv <- cbind(airbnb_nv,t(sapply(split,function(z)table(factor(z,levels=splitlevel)))))

#convert all amenities to factor
which( colnames(airbnb_nv)=="TV" )
which( colnames(airbnb_nv)=="Poolwithpoolhoist" )

airbnb_nv[,68:193] <- lapply(airbnb_nv[,68:193],as.factor)

#remove amenities with less than 1000 observations

amenities <- apply(airbnb_nv[,68:193], 2, table)

#apply(airbnb_nv[,69:194], 2, table)

airbnb_nv <- select(airbnb_nv, -`translationmissing:en.hosting_amenity_49`, -`translationmissing:en.hosting_amenity_50`, -Mobilehoist, -Balcony, -Kitchenette, -Airpurifier, -Poolwithpoolhoist, -Groundflooraccess, -Electricprofilingbed, -Lakeaccess, -Privatebathroom, -`Roll-inshower`, -Fireplaceguards, -Beachfront, -Disabledparkingspot, -Showerchair, -`Otherpet(s)`, -Beachessentials, -Hotwaterkettle, -Bathtubwithbathchair, -`Washer/Dryer`, -EVcharger, -Tablecornerguards, -Babymonitor, -Waterfront, -Firmmattress, -Fixedgrabbarsfortoilet, -Fixedgrabbarsforshower, -Changingtable, -Babybath, -Stairgates, -Outletcovers, -Pocketwifi,-`Children’sdinnerware`,-Cleaningbeforecheckout,-Flatpathtofrontdoor,-Handheldshowerhead,-Ethernetconnection,-Petsliveonthisproperty,-Crib,-Longtermstaysallowed, -'Children’sdinnerware', -`Skiin/Skiout`, -Pool, -Babysitterrecommendations, -Smartlock, -Gameconsole, -Wideclearancetoshower, -toilet,-`Children’sdinnerware`, -Highchair,-`Accessible-heighttoilet`,-BBQgrill,-Paidparkingonpremises)

sapply(airbnb_nv[,68:141], summary)

```


#convert to final dataset used for analyses
```{r}

airbnb_ny <- airbnb_nv

```


###Final check
```{r}
#Check NA's
na_per_column7 <- sort(colSums(sapply(airbnb_ny,is.na)), decreasing = TRUE)

#Percentage NA's per column
na_per_columnpercentage7 <- sort(colSums(sapply(airbnb_ny,is.na)/45903*100), decreasing = TRUE)

#Number and percentage of NA's per column
na_table7<- as.data.frame(cbind(na_per_column7, na_per_columnpercentage7))
na_table7

```


###remove columns not used in the final analyses
```{r}

airbnb_ny <- select(airbnb_ny,
                    -last_scraped,
                    -name,
                    -description,
                    -host_since,
                    -host_location,
                    -amenities,
                    -first_review,
                    -last_review,
                    -longitude,
                    -latitude)


```

#descriptives
##Numeric variables
```{r}
#numeric descriptives
df_numeric <- airbnb_ny %>% 
  select_if(is.numeric) %>% 
  select(-space, -neighborhood_overview, -notes, -transit, -access, -interaction,
         -house_rules, -host_about, -host_is_superhost, -host_has_profile_pic,
         -host_identity_verified, -mean_price, -instant_bookable,
         -require_guest_profile_picture, -require_guest_phone_verification, -host_local)

df_numeric_table <- df_numeric %>% gather(Variable, Value)
numeric_summary <- df_numeric_table %>% gather(Variable, Value) %>% 
  group_by(Variable) %>%  summarise(count = n(), 
           "% Missing" = round(sum(is.na(Value)))*100/length(Value),
            "Cardinality" = cardinality(Value),
            "Min" = min(Value, na.rm = TRUE),
            "1st Quartile" = quantile(Value, 0.25, na.rm = TRUE),
            "Mean" =mean(Value, na.rm = TRUE),
            "Median" = median(Value, na.rm = TRUE),
            "3rd Quartile" = quantile(Value, 0.75, na.rm = TRUE),
            "Max" = max(Value, na.rm = TRUE),
            "Std. Dev." = sd(Value, na.rm = TRUE))
kable(numeric_summary, digits = c(0, 0, 2, 0, 2, 2, 2, 2, 2, 2, 2), align= "c") %>% 
  kable_styling(full_width = TRUE, position = "center")

cornum <- cor(df_numeric)
corrplot(cornum, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45, mar=c(0.1,0.1,0.1,0.1))

round(cor(df_numeric), 2)

#remove correlated variables

airbnb_ny <- airbnb_ny %>% select(-review_scores_location, -review_scores_checkin, -review_scores_communication, -review_scores_value, -review_scores_accuracy, -availability_60, -availability_90, -accommodates)


```

##Categorical variables
```{r message = FALSE, echo = FALSE, warning = FALSE}
#change leftover variables to categorical
cols <- c("space", "neighborhood_overview", "notes", "transit", "access", "interaction",
          "house_rules", "host_about", "host_is_superhost", "host_has_profile_pic",
          "host_identity_verified", "instant_bookable", 
          "require_guest_profile_picture", "require_guest_phone_verification", "host_local",
          "property_type" )
airbnb_ny %<>%
       mutate_each_(funs(factor(.)),cols)

#create categorical summary
df_category <- airbnb_ny %>% select_if(is.factor)

df_category_table <- df_category %>% gather(Feature, Value)
category_summary <- df_category_table %>% gather(Feature, Value) %>% 
  group_by(Feature) %>%  summarise(count = n(),                      
            "%Missing" = round(sum(is.na(Value)))*100/length(Value), 
            "Cardinality" = cardinality(Value), 
            "Mode" = first_mode(Value), 
            "Mode Freq." = sort(table(Value), decreasing = TRUE) [1],
            "%Mode" = round(sort(table(Value), decreasing = TRUE) [1]*100/round(sum(!is.na(Value)))),
            "2nd Mode" = second_mode(Value),
            "2nd Mode Freq." = round(sort(table(Value), decreasing = TRUE)) [2],
            "%2nd Mode" = round(sort(table(Value), decreasing = TRUE) [2]*100/round(sum(!is.na(Value)))))
kable(category_summary, align= "c") %>% 
  kable_styling(full_width = TRUE, position = "center")


```

#meanprice analyses
```{r}

#numeric descriptives
df_target <- airbnb_ny %>% 
  select_if(is.numeric) %>% 
  select(mean_price)

df_target_table <- df_target %>% gather(Variable, Value)
target_summary <- df_target_table %>% gather(Variable, Value) %>% 
  group_by(Variable) %>%  summarise(count = n(), 
           "% Missing" = round(sum(is.na(Value)))*100/length(Value),
            "Cardinality" = cardinality(Value),
            "Min" = min(Value, na.rm = TRUE),
            "1st Quartile" = quantile(Value, 0.25, na.rm = TRUE),
            "Mean" =mean(Value, na.rm = TRUE),
            "Median" = median(Value, na.rm = TRUE),
            "3rd Quartile" = quantile(Value, 0.75, na.rm = TRUE),
            "Max" = max(Value, na.rm = TRUE),
            "Std. Dev." = sd(Value, na.rm = TRUE))
kable(target_summary, digits = c(0, 0, 2, 0, 2, 2, 2, 2, 2, 2, 2), align= "c") %>% 
  kable_styling(full_width = TRUE, position = "center")




```


#scale or normalize all numeric data for analyses
```{r}

#availability_30
summary(airbnb_ny$availability_30)

skewness(airbnb_ny$availability_30)

ggdensity(airbnb_ny$availability_30, 
         main = "availability_30",
         xlab = "availability_30")

airbnb_ny$availability_30 <- scale(airbnb_ny$availability_30)

#availability_365
summary(airbnb_ny$availability_365)

skewness(airbnb_ny$availability_365)

ggdensity(airbnb_ny$availability_365, 
         main = "availability_365",
         xlab = "availability_365")

airbnb_ny$availability_365 <- scale(airbnb_ny$availability_365)


#ave_description_sentiment
summary(airbnb_ny$ave_description_sentiment)

skewness(airbnb_ny$ave_description_sentiment)

ggdensity(airbnb_ny$ave_description_sentiment, 
         main = "ave_description_sentiment",
         xlab = "ave_description_sentiment")

airbnb_ny$ave_description_sentiment <- scale(airbnb_ny$ave_description_sentiment)

#ave_name_sentiment
summary(airbnb_ny$ave_name_sentiment)

skewness(airbnb_ny$ave_name_sentiment)

ggdensity(airbnb_ny$ave_name_sentiment, 
         main = "ave_name_sentiment",
         xlab = "ave_name_sentiment")

airbnb_ny$ave_name_sentiment <- scale(airbnb_ny$ave_name_sentiment)

#bathrooms
summary(airbnb_ny$bathrooms)

skewness(airbnb_ny$bathrooms)

ggdensity(airbnb_ny$bathrooms, 
         main = "bathrooms",
         xlab = "bathrooms")

airbnb_ny$bathrooms <- scale(airbnb_ny$bathrooms)

#bedrooms
summary(airbnb_ny$bedrooms)

skewness(airbnb_ny$bedrooms)

ggdensity(airbnb_ny$bedrooms, 
         main = "bedrooms",
         xlab = "bedrooms")

airbnb_ny$bedrooms <- scale(airbnb_ny$bedrooms)
#beds
summary(airbnb_ny$beds)

skewness(airbnb_ny$beds)

ggdensity(airbnb_ny$beds, 
         main = "beds",
         xlab = "beds")

airbnb_ny$beds <- scale(airbnb_ny$beds)

?scale

#cleaning_fee
summary(airbnb_ny$cleaning_fee)

skewness(airbnb_ny$cleaning_fee)

ggdensity(airbnb_ny$cleaning_fee, 
         main = "cleaning_fee",
         xlab = "cleaning_fee")

airbnb_ny$cleaning_fee <- scale(airbnb_ny$cleaning_fee)


#description_word_count
summary(airbnb_ny$description_word_count)

skewness(airbnb_ny$description_word_count)

ggdensity(airbnb_ny$description_word_count, 
         main = "description_word_count",
         xlab = "description_word_count")

airbnb_ny$description_word_count <- scale(airbnb_ny$description_word_count)

#extra_people
summary(airbnb_ny$extra_people)

skewness(airbnb_ny$extra_people)

ggdensity(airbnb_ny$extra_people, 
         main = "extra_people",
         xlab = "extra_people")

airbnb_ny$extra_people <- scale(airbnb_ny$extra_people)


#first_review_duration
summary(airbnb_ny$first_review_duration)

skewness(airbnb_ny$first_review_duration)

ggdensity(airbnb_ny$first_review_duration, 
         main = "first_review_duration",
         xlab = "first_review_duration")

airbnb_ny$first_review_duration <- scale(airbnb_ny$first_review_duration)


#guests_included
summary(airbnb_ny$guests_included)

skewness(airbnb_ny$guests_included)

ggdensity(airbnb_ny$guests_included, 
         main = "guests_included",
         xlab = "guests_included")

airbnb_ny$guests_included <- scale(airbnb_ny$guests_included)


#host_duration
summary(airbnb_ny$host_duration)

skewness(airbnb_ny$host_duration)

ggdensity(airbnb_ny$host_duration, 
         main = "host_duration",
         xlab = "host_duration")

airbnb_ny$host_duration <- scale(airbnb_ny$host_duration)


#host_response_rate
summary(airbnb_ny$host_response_rate)

skewness(airbnb_ny$host_response_rate)

ggdensity(airbnb_ny$host_response_rate, 
         main = "host_response_rate",
         xlab = "host_response_rate")

airbnb_ny$host_response_rate <- scale(airbnb_ny$host_response_rate)

#host_listings_count
summary(airbnb_ny$host_duration)

skewness(airbnb_ny$host_listings_count)

ggdensity(airbnb_ny$host_listings_count, 
         main = "host_listings_count",
         xlab = "host_listings_count")

airbnb_ny$host_listings_count <- scale(airbnb_ny$host_listings_count)


#last_review_duration
summary(airbnb_ny$last_review_duration)

skewness(airbnb_ny$last_review_duration)

ggdensity(airbnb_ny$last_review_duration, 
         main = "last_review_duration",
         xlab = "last_review_duration")

airbnb_ny$last_review_duration <- scale(airbnb_ny$last_review_duration)


#maximum_nights
summary(airbnb_ny$maximum_nights)

skewness(airbnb_ny$maximum_nights)

ggdensity(airbnb_ny$maximum_nights, 
         main = "maximum_nights",
         xlab = "maximum_nights")

airbnb_ny$maximum_nights <- scale(airbnb_ny$maximum_nights)


#minimum_nights
summary(airbnb_ny$minimum_nights)

skewness(airbnb_ny$minimum_nights)

ggdensity(airbnb_ny$minimum_nights, 
         main = "minimum_nights",
         xlab = "minimum_nights")

airbnb_ny$minimum_nights <- scale(airbnb_ny$minimum_nights)

#name_word_count
summary(airbnb_ny$name_word_count)

skewness(airbnb_ny$name_word_count)

ggdensity(airbnb_ny$name_word_count, 
         main = "name_word_count",
         xlab = "name_word_count")

airbnb_ny$name_word_count <- scale(airbnb_ny$name_word_count)

#number_of_reviews
summary(airbnb_ny$number_of_reviews)

skewness(airbnb_ny$number_of_reviews)

ggdensity(airbnb_ny$number_of_reviews, 
         main = "number_of_reviews",
         xlab = "number_of_reviews")

airbnb_ny$number_of_reviews <- scale(airbnb_ny$number_of_reviews)

#review_scores_rating
summary(airbnb_ny$review_scores_rating)

skewness(airbnb_ny$review_scores_rating)

ggdensity(airbnb_ny$review_scores_rating, 
         main = "review_scores_rating",
         xlab = "review_scores_rating")

airbnb_ny$review_scores_rating <- scale(airbnb_ny$review_scores_rating)


#review_scores_cleanliness
summary(airbnb_ny$review_scores_cleanliness)

skewness(airbnb_ny$review_scores_cleanliness)

ggdensity(airbnb_ny$review_scores_cleanliness, 
         main = "review_scores_cleanliness",
         xlab = "review_scores_cleanliness")


airbnb_ny$review_scores_cleanliness <- scale(airbnb_ny$review_scores_cleanliness)


#reviews_per_month
summary(airbnb_ny$reviews_per_month)

skewness(airbnb_ny$reviews_per_month)

ggdensity(airbnb_ny$reviews_per_month, 
         main = "reviews_per_month",
         xlab = "reviews_per_month")

airbnb_ny$reviews_per_month <- scale(airbnb_ny$reviews_per_month)

#security_deposit
summary(airbnb_ny$security_deposit)

skewness(airbnb_ny$security_deposit)

ggdensity(airbnb_ny$security_deposit, 
         main = "security_deposit",
         xlab = "security_deposit")

airbnb_ny$security_deposit <- scale(airbnb_ny$security_deposit)


#total_amenities
summary(airbnb_ny$total_amenities)

skewness(airbnb_ny$total_amenities)

ggdensity(airbnb_ny$total_amenities, 
         main = "total_amenities",
         xlab = "total_amenities")

airbnb_ny$total_amenities <- scale(airbnb_ny$total_amenities)


###################################



```

#log target variable
```{r}
summary(airbnb_ny$mean_price)

summary(log(airbnb_ny$mean_price))

ggdensity(airbnb_ny$mean_price, 
          main = "Density plot of Airbnb daily listing price",
          xlab = "Daily Listing Price")

skewness(airbnb_ny$mean_price)

airbnb_ny <- airbnb_ny %>% mutate(log_price = log(airbnb_ny$mean_price))


ggdensity(airbnb_ny$log_price, 
          main = "Density plot of log_price",
          xlab = "Log Price")

skewness(airbnb_ny$log_price)
```

#place target variable (price and log price) as first columns
```{r}
#do at beginning dataset

airbnb_ny <- airbnb_ny %>%
  select(mean_price, log_price, everything())

str(airbnb_ny)

class(airbnb_ny)

airbnb_ny

#write.csv(airbnb_ny, file = "airbnb_ny.csv")

#rm(list = ls()[!ls() %in% c("airbnb_final")]) 

```

#clear workspace and only use dataset for analyses
```{r}

#rm(list = ls()[!ls() %in% c("airbnb_ny")])

```


#keep only mean_price and log_mean price

```{r}



airbnb_ny_price <- select(airbnb_ny, 
                          -log_price)

airbnb_ny_log <- select(airbnb_ny,
                          -mean_price)

```

###PREDICTION
#create train/test sets for ny
```{r}

#creating train/validate and test sets for NY log (30% test and 70% train)
sample_size = floor(0.70*nrow(airbnb_ny_log)) 

set.seed(0613247396)
train_ind = sample(seq_len(nrow(airbnb_ny_log)),size = sample_size)

train_log = airbnb_ny_log[train_ind,]

test_log = airbnb_ny_log[-train_ind,]

str(airbnb_ny_log)


```


#start prediction
#lasso
```{r }

#NY data
set.seed(123123)
control <- trainControl(method = "cv", number = 5)

lasso <- train(log_price ~ ., data = train_log, method = "glmnet",
                trControl=control, 
                tuneGrid = expand.grid(alpha = 1,
                                       lambda = seq(0.0001, 1, length = 200)))

lasso

prediction_lasso <- predict(lasso, test_log)

#results
postResample(prediction_lasso, test_log$log_price)

#variable importance
lassoImp <- varImp(lasso, scale = FALSE)
lassoImp

plot(lassoImp, top = 20, main = "Variable Importance Plot: Lasso")

?plot

#plot important variables

#variable importance table
lassoImpTable <- varImp(object=lasso, scale = FALSE)$importance %>% 
  as.data.frame() %>%
  rownames_to_column() %>%
  arrange(desc(Overall)) 


plot(varImp(object=lasso,scale=FALSE, top = 20))

options(repr.plot.width=8, repr.plot.height=4)
lasso_plot = as.data.frame(cbind(predicted = prediction_lasso,
                            observed = test_log$log_price))
# Plot predictions vs test data
ggplot(lasso_plot,aes(predicted, observed)) + geom_point(color = "darkred", alpha = 0.5) + 
    geom_smooth(method="lm")+ ggtitle('Lasso Regression ') + ggtitle("Lasso Model: Prediction vs Test Data") +
      xlab("Predicted Output ") + ylab("Observed Output") + 
        theme(plot.title = element_text(color="darkblue",size=16,hjust = 0.5),
         axis.text.y = element_text(size=12), axis.text.x = element_text(size=12,hjust=.5),
         axis.title.x = element_text(size=14), axis.title.y = element_text(size=14))


lassocoefficients <- as.data.frame(as.matrix(coef(lasso$finalModel, 0.0001)))

as.data.frame(as.matrix(coef(lasso$finalModel, 0.0001)))

lassocoefficients

```




#randomforest (for accuracy)
```{r}

library("MASS")
library("randomForest")
library("ranger")

#NY dataset
set.seed(123123)


rf_grid <- expand.grid(mtry = c(190),
                       splitrule = c("extratrees"),
                       min.node.size = c(11))

randomforest2 <- train(log_price ~ .,
                             data = train_log,
                             method = "ranger",
                             importance = "impurity",
                             tuneGrid = rf_grid)

randomforest2

prediction_randomforest2 <- predict(randomforest2, test_log)

#results
postResample(prediction_randomforest2, test_log$log_price)

#variable importance
varImp(object=randomforest2, scale = FALSE)

#variable importance table
varImp(object=randomforest2, scale = FALSE)$importance %>% 
  as.data.frame() %>%
  rownames_to_column() %>%
  arrange(desc(Overall)) 

options(repr.plot.width=8, repr.plot.height=4)
randomforest2_plot = as.data.frame(cbind(predicted = prediction_randomforest2,
                            observed = test_log$log_price))
# Plot predictions vs test data
ggplot(randomforest2_plot,aes(predicted, observed)) + geom_point(color = "darkred", alpha = 0.5) + 
    geom_smooth(method="lm")+ ggtitle('Random Forest ') + ggtitle("Random Forest: Prediction vs Test Data") +
      xlab("Predicted Output ") + ylab("Observed Output") + 
        theme(plot.title = element_text(color="darkblue",size=16,hjust = 0.5),
         axis.text.y = element_text(size=12), axis.text.x = element_text(size=12,hjust=.5),
         axis.title.x = element_text(size=14), axis.title.y = element_text(size=14))

randomforest2$finalModel

randomforest2$times


```

#randomforest (for variable importance)
```{r}

library("MASS")
library("randomForest")
library("ranger")

#NY dataset
set.seed(123123)


rf_grid <- expand.grid(mtry = c(190),
                       splitrule = c("extratrees"),
                       min.node.size = c(11))

randomforestImp <- train(log_price ~ .,
                             data = train_log,
                             method = "ranger",
                             importance = "impurity_corrected",
                             tuneGrid = rf_grid)

randomforestImp

prediction_randomforestImp <- predict(randomforestImp, test_log)

#results
postResample(prediction_randomforestImp, test_log$log_price)

#variable importance
rfImp <- varImp(object=randomforestImp, scale = FALSE)
rfImp

plot(rfImp, top = 20, main = "Variable Importance Plot: Random Forest")

#variable importance table
rfImpTable <- varImp(object=randomforestImp, scale = FALSE)$importance %>% 
  as.data.frame() %>%
  rownames_to_column() %>%
  arrange(desc(Overall)) 

options(repr.plot.width=8, repr.plot.height=4)
randomforestImp_plot = as.data.frame(cbind(predicted = prediction_randomforestImp,
                            observed = test_log$log_price))
# Plot predictions vs test data
ggplot(randomforestImp_plot,aes(predicted, observed)) + geom_point(color = "darkred", alpha = 0.5) + 
    geom_smooth(method="lm")+ ggtitle('Random Forest ') + ggtitle("Random Forest: Prediction vs Test Data") +
      xlab("Predicted Output ") + ylab("Observed Output") + 
        theme(plot.title = element_text(color="darkblue",size=16,hjust = 0.5),
         axis.text.y = element_text(size=12), axis.text.x = element_text(size=12,hjust=.5),
         axis.title.x = element_text(size=14), axis.title.y = element_text(size=14))



```


#XGBM (FINAL)
```{r}

#NY dataset
set.seed(123123)

control <- trainControl(method = "cv", number = 5)

parametersGrid2 <- expand.grid(eta=c(0.01),
                              colsample_bytree=c(0.75),
                              max_depth=c(6),
                              nrounds=c(2000,3000,4000),
                              gamma=1,
                              min_child_weight=c(2,3),
                              subsample=c(0.75))

parametersGrid2


xgb <- train(log_price ~ ., data = train_log,
                    method='xgbTree',
                    trControl = control,
                    tuneGrid=parametersGrid2)

xgb

prediction_xgb <- predict(xgb, test_log, type="raw")

#result
postResample(prediction_xgb, test_log$log_price)

#variable importance
xgbimp <- varImp(object=xgb, scale = FALSE)
xgbimp

plot(xgbimp, top = 20, main = "Variable Importance Plot: Extreme Gradient Boosting")

#variable importance table
xgbimpTable <- varImp(object=xgb, scale = FALSE)$importance %>% 
  as.data.frame() %>%
  rownames_to_column() %>%
  arrange(desc(Overall))  

options(repr.plot.width=8, repr.plot.height=4)
xgb_plot2 = as.data.frame(cbind(predicted = prediction_xgb,
                            observed = test_log$log_price))
# Plot predictions vs test data
ggplot(xgb_plot2,aes(predicted, observed)) + geom_point(color = "darkred", alpha = 0.5) + 
    geom_smooth(method="lm")+ ggtitle('Extreme Gradient Boosting ') + ggtitle("Extreme Gradient Boosting: Prediction vs Test Data") +
      xlab("Predicted Output ") + ylab("Observed Output") + 
        theme(plot.title = element_text(color="darkblue",size=16,hjust = 0.5),
         axis.text.y = element_text(size=12), axis.text.x = element_text(size=12,hjust=.5),
         axis.title.x = element_text(size=14), axis.title.y = element_text(size=14))




```



#Visualize results
```{r}
devtools::install_github("laresbernardo/lares")
library("lares")

#lasso
lares::mplot_lineal(tag = test_log$log_price, 
                    score = prediction_lasso,
                    subtitle = "Lasso",
                    model_name = "Actual vs predicted values")

lares::mplot_density(tag = test_log$log_price, 
                    score = prediction_xgb,
                    subtitle = "Lasso",
                    model_name = "Density plot: Actual vs predicted values")

#random forest
lares::mplot_lineal(tag = test_log$log_price, 
                    score = prediction_randomforest2,
                    subtitle = "Random Forest",
                    model_name = "Actual vs predicted values")

lares::mplot_density(tag = test_log$log_price, 
                    score = prediction_randomforest2,
                    subtitle = "Random Forest",
                    model_name = "Density plot: Actual vs predicted values")

#xgb
lares::mplot_lineal(tag = test_log$log_price, 
                    score = prediction_xgb,
                    subtitle = "Extreme Gradient Boosting",
                    model_name = "Actual vs predicted values")

lares::mplot_density(tag = test_log$log_price, 
                    score = prediction_xgb,
                    subtitle = "Regression Model",
                    model_name = "Density plot: Actual vs predicted values")


```

